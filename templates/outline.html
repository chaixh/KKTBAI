<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Good Autobid - 大纲生成</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav { margin: 20px 0; }
        .nav a { margin-right: 20px; text-decoration: none; color: #007bff; font-size: 16px; }
        button { padding: 10px 20px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #outlineResult {
            width: 100%;
            height: 400px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap; /* 保留换行和空格 */
            word-break: break-all; /* 自动换行，防止内容溢出 */
            overflow-y: auto; /* 内容超出时显示滚动条 */
            line-height: 1.6; /* 优化行高，提升可读性 */
        }
        /* 新增：美化Markdown渲染后的样式 */
        #outlineResult h1 { font-size: 20px; margin: 15px 0 10px; color: #2c3e50; }
        #outlineResult h2 { font-size: 18px; margin: 12px 0 8px; color: #34495e; padding-left: 10px; border-left: 3px solid #007bff; }
        #outlineResult h3 { font-size: 16px; margin: 10px 0 6px; color: #4a6583; padding-left: 20px; }
        #outlineResult p { margin: 6px 0; color: #666; padding-left: 30px; }
    </style>
    <!-- 引入marked.js：用于格式化Markdown内容，让大纲层级更清晰（CDN方式，无需本地下载） -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/">技术要求</a>
            <a href="/outline">大纲生成</a>
            <a href="/document">终稿生成</a>
        </div>
        <h1>投标文件大纲生成</h1>
        <!-- 给按钮添加id，用于控制禁用/启用状态 -->
        <button id="generateBtn" onclick="generateOutline()">生成大纲</button>
        <h3>大纲结果（生成后将显示在此处）</h3>
        <div id="outlineResult" contenteditable="true" placeholder="点击「生成大纲」按钮，等待生成结果..."></div>
        <button onclick="saveOutline()">保存大纲</button>
    </div>

    <script>
        // 获取生成按钮元素
        const generateBtn = document.getElementById('generateBtn');

        // 核心新增：将JSON格式的大纲转为美观的Markdown字符串
        function convertOutlineToMarkdown(outlineObj) {
            // 校验输入是否为合法对象
            if (!outlineObj || typeof outlineObj !== 'object' || !outlineObj.body_paragraphs) {
                return "⚠️ 大纲格式异常，无法转换为Markdown\n" + JSON.stringify(outlineObj, null, 2);
            }

            let mdContent = "";
            // 遍历章节
            outlineObj.body_paragraphs.forEach((chapter, chapterIdx) => {
                // 章节标题（一级标题）
                mdContent += `# ${chapter.chapter_title || `第${chapterIdx+1}章 未命名章节`}\n\n`;

                // 遍历小节
                if (chapter.sections && Array.isArray(chapter.sections)) {
                    chapter.sections.forEach((section, sectionIdx) => {
                        // 小节标题（二级标题）
                        mdContent += `## ${section.section_title || `1.${sectionIdx+1} 未命名小节`}\n\n`;

                        // 遍历子小节
                        if (section.sub_sections && Array.isArray(section.sub_sections)) {
                            section.sub_sections.forEach((subSection, subIdx) => {
                                // 子小节标题（三级标题）
                                mdContent += `### ${subSection.sub_section_title || `1.${sectionIdx+1}.${subIdx+1} 未命名子小节`}\n\n`;
                                // 子小节内容摘要
                                mdContent += `${subSection.content_summary || "无内容摘要"}\n\n`;
                            });
                        } else {
                            mdContent += "⚠️ 该小节无子章节\n\n";
                        }
                    });
                } else {
                    mdContent += "⚠️ 该章节无小节\n\n";
                }
                // 章节之间添加分隔线
                mdContent += "---\n\n";
            });

            return mdContent.trim(); // 去除首尾空白
        }

        async function generateOutline() {
            const outlineResult = document.getElementById('outlineResult');
            // 生成中提示
            outlineResult.innerText = "正在生成大纲，请稍候...（LLM生成需要一定时间，请勿刷新页面）";
            // 禁用按钮，防止重复点击
            generateBtn.disabled = true;
            generateBtn.innerText = "生成中...";

            try {
                const response = await fetch('/generate_outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('接口响应状态码：', response.status);
                console.log('接口响应是否成功：', response.ok);
                const rawResponse = await response.text();
                console.log('接口原始返回内容：', rawResponse);

                let result;
                try {
                    result = JSON.parse(rawResponse);
                } catch (jsonError) {
                    throw new Error(`后端返回非JSON格式：${rawResponse}，解析失败：${jsonError.message}`);
                }

                // 核心重构：清晰的状态判断和内容处理逻辑
                let isSuccess = false;
                let errorMsg = "后端未返回错误信息";
                let finalMarkdown = "";

                // 适配后端返回格式（优先最新格式，兼容旧格式）
                if (result.status === "success") {
                    isSuccess = true;
                    // 情况1：后端返回了outline对象（核心修复点）
                    if (result.outline && typeof result.outline === 'object') {
                        finalMarkdown = convertOutlineToMarkdown(result.outline);
                    }
                    // 情况2：后端直接返回了markdown字符串
                    else if (result.outline_md && typeof result.outline_md === 'string') {
                        finalMarkdown = result.outline_md;
                    }
                    // 情况3：兼容旧的content字段
                    else if (result.data?.md_content || result.data?.outline_content) {
                        finalMarkdown = result.data.md_content || result.data.outline_content;
                    }
                    // 兜底：转为JSON字符串
                    else {
                        finalMarkdown = JSON.stringify(result.outline || result.data || "", null, 2);
                    }
                } else {
                    errorMsg = result.message || "大纲生成失败，后端未返回具体原因";
                }

                // 渲染结果到页面
                if (isSuccess) {
                    if (finalMarkdown) {
                        // 核心修复：确保传入marked的是字符串（最终兜底校验）
                        const renderContent = typeof finalMarkdown === 'string' ? finalMarkdown : JSON.stringify(finalMarkdown, null, 2);
                        outlineResult.innerHTML = marked.parse(renderContent);
                        console.log('大纲渲染成功，内容长度：', renderContent.length);
                    } else {
                        outlineResult.innerText = "✅ 大纲生成成功，但无有效内容（请检查输入的技术要求/评分标准是否为空）";
                    }
                    alert('✅ 大纲生成成功！可直接编辑或点击「保存大纲」');
                } else {
                    outlineResult.innerText = "❌ 大纲生成失败：" + errorMsg;
                    alert('❌ 大纲生成失败：' + errorMsg);
                }
            } catch (error) {
                console.error('生成大纲失败（详细错误）：', error);
                const errorMsg = error.message || "网络异常或服务未响应";
                outlineResult.innerText = "❌ 大纲生成失败：" + errorMsg;
                alert('❌ 生成大纲失败：' + errorMsg);
            } finally {
                // 无论成功失败，都恢复按钮状态
                generateBtn.disabled = false;
                generateBtn.innerText = "生成大纲";
            }
        }

        function saveOutline() {
            const outlineResult = document.getElementById('outlineResult');
            if (outlineResult.innerText.includes("生成失败") || outlineResult.innerText.includes("请稍候")) {
                alert('❌ 暂无有效大纲可保存，请先成功生成大纲！');
                return;
            }
            // 模拟保存逻辑（实际可对接后端保存接口）
            alert('✅ 大纲已保存到本地！请切换到「终稿生成」页面继续操作。');
            // 可选：自动跳转到终稿页面
            // window.location.href = '/document';
        }
    </script>

</body>
</html>