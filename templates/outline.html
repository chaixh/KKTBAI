<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Good Autobid - 大纲生成</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav { margin: 20px 0; }
        .nav a { margin-right: 20px; text-decoration: none; color: #007bff; font-size: 16px; }
        button { padding: 10px 20px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #outlineResult {
            width: 100%;
            height: 400px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap; /* 保留换行和空格 */
            word-break: break-all; /* 自动换行，防止内容溢出 */
            overflow-y: auto; /* 内容超出时显示滚动条 */
        }
    </style>
    <!-- 引入marked.js：用于格式化Markdown内容，让大纲层级更清晰（CDN方式，无需本地下载） -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/">技术要求</a>
            <a href="/outline">大纲生成</a>
            <a href="/document">终稿生成</a>
        </div>
        <h1>投标文件大纲生成</h1>
        <!-- 给按钮添加id，用于控制禁用/启用状态 -->
        <button id="generateBtn" onclick="generateOutline()">生成大纲</button>
        <h3>大纲结果（生成后将显示在此处）</h3>
        <div id="outlineResult" contenteditable="true" placeholder="点击「生成大纲」按钮，等待生成结果..."></div>
        <button onclick="saveOutline()">保存大纲</button>
    </div>

    <script>
        // 获取生成按钮元素
        const generateBtn = document.getElementById('generateBtn');

        async function generateOutline() {
            const outlineResult = document.getElementById('outlineResult');
            // 生成中提示
            outlineResult.innerText = "正在生成大纲，请稍候...（LLM生成需要一定时间，请勿刷新页面）";
            // 禁用按钮，防止重复点击
            generateBtn.disabled = true;
            generateBtn.innerText = "生成中...";

            try {
                const response = await fetch('/generate_outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('接口响应状态码：', response.status);
                console.log('接口响应是否成功：', response.ok);
                const rawResponse = await response.text();
                console.log('接口原始返回内容：', rawResponse);

                let result;
                try {
                    result = JSON.parse(rawResponse);
                } catch (jsonError) {
                    throw new Error(`后端返回非JSON格式：${rawResponse}，解析失败：${jsonError.message}`);
                }

                // 核心修改：1. 优先获取后端返回的md_content（本地文件真实内容），兼容多种格式
                let isSuccess = false;
                let errorMsg = "后端未返回错误信息";
                let outlineContent = "";

                // 适配后端最新返回格式（success/msg/data，包含md_content）
                if (result.hasOwnProperty('success')) {
                    isSuccess = result.success;
                    errorMsg = result.msg || "后端未返回错误信息";
                    // 优先获取Markdown格式内容，其次是旧的outline_content
                    outlineContent = result.data?.md_content || result.data?.outline_content || "";
                }
                // 兼容后端旧格式（status/message）
                else if (result.hasOwnProperty('status')) {
                    isSuccess = result.status === "success";
                    errorMsg = result.message || "后端未返回错误信息";
                    // 兼容旧格式的大纲内容
                    outlineContent = result.outline || result.data?.outline_content || "";
                }

                // 正常逻辑处理
                if (isSuccess) {
                    if (outlineContent) {
                        // 核心修改：2. 用marked.js格式化Markdown内容，渲染为美观的层级结构
                        // 若需纯文本显示，可替换为 outlineResult.innerText = outlineContent;
                        outlineResult.innerHTML = marked.parse(outlineContent);
                    } else {
                        outlineResult.innerText = "大纲生成成功，但无返回内容（请检查输入内容或模型配置）";
                    }
                    alert('大纲生成成功！');
                } else {
                    outlineResult.innerText = "大纲生成失败：" + errorMsg;
                    alert('大纲生成失败：' + errorMsg);
                }
            } catch (error) {
                console.error('生成大纲失败（详细错误）：', error);
                const errorMsg = error.message || "网络异常或服务未响应";
                outlineResult.innerText = "大纲生成失败：" + errorMsg;
                alert('生成大纲失败：' + errorMsg);
            } finally {
                // 无论成功失败，都恢复按钮状态
                generateBtn.disabled = false;
                generateBtn.innerText = "生成大纲";
            }
        }

        function saveOutline() {
            alert('大纲保存成功，请切换到「终稿生成」页面！');
        }
    </script>

</body>
</html>